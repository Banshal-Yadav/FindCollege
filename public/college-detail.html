<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Details</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <style>
        .college-detail-container {
            max-width: 1000px;
            margin: 50px auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .college-header {
            padding: 30px;
            background: linear-gradient(45deg, #3a6ec5, #2c5282);
            color: white;
            position: relative;
        }

        .college-header h1 {
            margin-top: 0;
            font-size: 2rem;
        }

        .college-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .college-meta span {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .college-meta i {
            color: #f0810f;
        }

        .college-body {
            padding: 30px;
        }

        .college-section {
            margin-bottom: 30px;
        }

        .college-section h2 {
            color: #2c5282;
            border-bottom: 2px solid #edf2f7;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: #edf2f7;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c5282;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #718096;
            text-align: center;
        }

        .back-btn {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            background: #f0810f;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }

        .course-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .course-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            background: #f8fafc;
            transition: all 0.3s;
        }

        .course-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transform: translateY(-5px);
        }

        .course-name {
            color: #2c5282;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .course-details {
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .course-details p {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }

        .course-details .label {
            color: #718096;
        }

        /* Add these styles in your existing style tag */
        .events-list {
            margin-top: 15px;
        }

        .event-card {
            border-left: 4px solid #3a6ec5;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8fafc;
            border-radius: 4px;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .event-title {
            font-weight: bold;
            color: #2c5282;
            font-size: 1.1rem;
        }

        .event-date {
            font-weight: 600;
            color: #718096;
        }

        .event-location {
            color: #4a5568;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .event-description {
            margin-top: 8px;
            color: #4a5568;
        }

        .event-register {
            display: inline-block;
            margin-top: 10px;
            padding: 6px 12px;
            background: #3a6ec5;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        /* Map and facilities grid */
        .map-facilities-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (min-width: 768px) {
            .map-facilities-grid {
                grid-template-columns: 1.5fr 1fr;
            }
        }

        /* Facilities section styling */
        .facilities-container {
            background: #f8fafc;
            border-radius: 8px;
            overflow: hidden;
            height: 100%;
        }

        .facilities-header {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            background: #f1f5f9;
        }

        .facilities-title {
            margin: 0 0 10px 0;
            color: #2c5282;
            font-size: 1.2rem;
        }

        .facilities-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .filter-btn {
            background: #e2e8f0;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #3a6ea5;
            color: white;
        }

        .facilities-list {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .facility-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.2s;
        }

        .facility-item:last-child {
            border-bottom: none;
        }

        .facility-item:hover {
            background-color: #edf2f7;
        }

        .facility-icon {
            width: 40px;
            height: 40px;
            background: #3a6ea5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .facility-info {
            flex: 1;
        }

        .facility-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 3px;
        }

        .facility-location {
            color: #718096;
            font-size: 0.9rem;
        }

        .facility-distance {
            font-size: 0.85rem;
            color: #3a6ea5;
            background: #ebf4ff;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }

        .no-facilities {
            color: #718096;
            text-align: center;
            padding: 20px;
        }

        /* Rating system styling */
        .rating-section {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .rating-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .rating-title {
            font-size: 1.2rem;
            color: #2c5282;
            font-weight: 600;
        }

        .average-rating {
            font-size: 0.9rem;
            color: #718096;
        }

        .average-rating span {
            font-weight: 600;
            color: #2c5282;
        }

        .rating-stars {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .star-container {
            display: flex;
            gap: 5px;
        }

        .star {
            font-size: 24px;
            color: #e2e8f0;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star.active {
            color: #f6ad55;
        }

        .star:hover, .star.hover {
            color: #ed8936;
        }

        .rating-submit {
            margin-top: 15px;
        }

        .rating-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rating-message {
            font-size: 0.9rem;
        }

        .rating-message.success {
            color: #38a169;
        }

        .rating-message.error {
            color: #e53e3e;
        }

        .rating-avg-display {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: #f6ad55;
            font-weight: 600;
        }

        .rating-count {
            font-size: 0.8rem;
            color: #718096;
        }

        .rate-btn {
            background: #3a6ec5;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .rate-btn:hover {
            background: #2c5282;
        }

        .rate-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .login-to-rate {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 10px;
            text-align: center;
        }

        /* Review System Styling */
        .reviews-section {
            margin-top: 30px;
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
        }
        
        .review-form {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .review-list {
            margin-top: 20px;
        }
        
        .review-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .user-badge {
            display: inline-block;
            background: #ebf8ff;
            color: #3182ce;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 6px;
        }
        
        .verified-badge {
            display: inline-block;
            background: #c6f6d5;
            color: #38a169;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 6px;
        }
        
        .review-helpful {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #718096;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .like-button {
            background: none;
            border: none;
            color: #718096;
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .like-button:hover {
            background: #e2e8f0;
        }
        
        .like-button.liked {
            color: #3182ce;
        }
        
        .review-pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 8px;
        }
        
        .pagination-button {
            background: #e2e8f0;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .pagination-button.active {
            background: #4299e1;
            color: white;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .review-message.error {
            color: #e53e3e;
        }
    </style>
</head>

<body>

    <header style="background-color: #fff; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto;">
            <a href="/" style="text-decoration: none; color: #2c5282; font-size: 1.5rem; font-weight: bold;">
                FindCollege
            </a>

            <div>
                <a href="/" style="margin-right: 15px; color: #555; text-decoration: none;">Home</a>
                <a href="/login.html" id="loginLink"
                    style="color: #3a6ea5; margin-right: 15px; text-decoration: none;">Login</a>
                <a href="/register.html" id="registerLink"
                    style="color: #3a6ea5; margin-right: 15px; text-decoration: none;">Register</a>
                <a href="#" id="logoutLink" style="color: #3a6ea5; display: none; text-decoration: none;">Logout</a>
                <span id="userWelcome" style="color: #333; display: none;">Welcome, <span id="username"></span></span>
            </div>
        </div>
    </header>

    <div id="collegeDetailContainer" class="college-detail-container">
        <div id="loading" style="padding: 30px; text-align: center;">Loading college details...</div>
    </div>

    <footer>
        <div class="footer-container">
            <div class="footer-section">
                <h2>about us</h2>
                <p>Assisting students</p>
            </div>
            <div class="footer-section-link">
                <h2>Quick links</h2>
                <ul>
                    <li><a href="/">Home</a></li>
                    <li><a href="#">About</a></li>
                    <li><a href="#">Services</a></li>
                    <li><a href="#">contact</a></li>
                    <li><a href="/admin/login.html" style="opacity:0.7;">Admin</a></li>
                </ul>
            </div>
            <div class="footer-bottom">
                <p>&copy;2025 FindCollege.All Rights Reserved</p>
            </div>
        </div>
    </footer>

    <!-- Login Prompt Modal -->
    <div id="loginPromptModal" class="modal">
        <div class="modal-content">
            <span class="close-btn"
                onclick="document.getElementById('loginPromptModal').style.display='none'">&times;</span>
            <h2>Login Required</h2>
            <p>You need to be logged in to apply for this college.</p>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <a href="/login.html" class="apply-now-btn"
                    style="text-decoration: none; text-align: center; flex: 1;">Login</a>
                <a href="/register.html" class="apply-now-btn"
                    style="background: linear-gradient(45deg, #3182ce, #2c5282); text-decoration: none; text-align: center; flex: 1;">Register</a>
            </div>
        </div>
    </div>

    <!-- Application Form Modal (new) -->
    <div id="applicationFormModal" class="application-modal">
        <div class="application-modal-content">
            <span class="close-btn" onclick="document.getElementById('applicationFormModal').style.display='none'">&times;</span>
            <h2>Apply for <span id="collegeNameInForm"></span></h2>
            <p>Please complete this form to receive a callback from the admissions team.</p>
            
            <form id="applicationForm" class="application-form">
                <input type="hidden" id="applicationCollegeId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="fullName">Full Name*</label>
                        <input type="text" id="fullName" required>
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber">Phone Number*</label>
                        <input type="tel" id="phoneNumber" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="preferredCourse">Preferred Course*</label>
                        <select id="preferredCourse" required>
                            <option value="">Select a course</option>
                            <!-- Courses will be dynamically loaded -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="educationLevel">Highest Education*</label>
                        <select id="educationLevel" required>
                            <option value="">Select education level</option>
                            <option value="High School">High School</option>
                            <option value="Undergraduate">Undergraduate</option>
                            <option value="Graduate">Graduate</option>
                            <option value="Post-Graduate">Post-Graduate</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="message">Additional Message</label>
                    <textarea id="message" placeholder="Any specific queries or information you want to share..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="preferredTime">Preferred Time for Callback</label>
                    <select id="preferredTime">
                        <option value="Morning">Morning (9AM - 12PM)</option>
                        <option value="Afternoon">Afternoon (12PM - 4PM)</option>
                        <option value="Evening">Evening (4PM - 7PM)</option>
                    </select>
                </div>
                
                <button type="submit" class="submit-btn">Submit Application</button>
                <div id="applicationMessage" style="margin-top: 15px; text-align: center; display: none;"></div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Get college ID from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const collegeId = urlParams.get('id');

            if (!collegeId) {
                document.getElementById('collegeDetailContainer').innerHTML =
                    '<div style="padding:30px; text-align:center;">College not found. <a href="/">Go back</a></div>';
                return;
            }

            // Fetch college details from API
            fetch(`/college/${collegeId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('College not found');
                    }
                    return response.json();
                })
                .then(college => {
                    // Update page title
                    document.title = `${college.name} - College Details`;

                    // Fallback values for optional fields
                    const description = college.description || "This college is known for its academic excellence and comprehensive education approach.";
                    const established = college.established_year || "N/A";
                    const students = college.total_students || "N/A";
                    const placement = college.placement_rate || 95;
                    const avgPackage = college.avg_package || 12.5;

                    const container = document.getElementById('collegeDetailContainer');
                    container.innerHTML = `
                        <div class="college-header">
                            <h1>${college.name}</h1>
                            <div class="college-meta">
                                <span><i class="fas fa-map-marker-alt"></i> ${college.location}</span>
                                <span><i class="fas fa-trophy"></i> NIRF Rank: #${college.ranking}</span>
                                <span><i class="fas fa-calendar-alt"></i> Est. ${established}</span>
                                <span><i class="fas fa-globe"></i> ${college.website || 'Website: N/A'}</span>
                            </div>
                            <button id="applyNowBtn" class="apply-now-btn">Apply Now</button>
                        </div>
                        
                        <div class="college-body">
                            <div class="college-section">
                                <h2>College Overview</h2>
                                <p>${description}</p>
                                <p>${college.accreditation ? `<strong>Accreditation:</strong> ${college.accreditation}` : ''}</p>
                            </div>
                            
                            <div class="college-section">
                                <h2>Key Statistics</h2>
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="value">${placement}%</div>
                                        <div class="label">Placement Rate</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="value">₹${avgPackage} LPA</div>
                                        <div class="label">Average Package</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="value">${students}+</div>
                                        <div class="label">Students</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="value">#${college.ranking}</div>
                                        <div class="label">NIRF Ranking</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="college-section">
                                <h2>Ratings & Reviews</h2>
                                <div class="rating-section">
                                    <div class="rating-header">
                                        <div class="rating-title">Rate this college</div>
                                        <div class="average-rating">Average rating: <span id="avgRatingValue">0</span>/5 (<span id="ratingCount">0</span> ratings | <span id="totalReviews">0</span> reviews)</div>
                                    </div>
                                    <div class="rating-content">
                                        <div id="loginToRate" class="login-to-rate" style="display: none;">
                                            <p>Please <a href="/login.html">login</a> to rate this college.</p>
                                        </div>
                                        <div id="ratingControls" style="display: none;">
                                            <div class="star-container">
                                                <span class="star" data-value="1">★</span>
                                                <span class="star" data-value="2">★</span>
                                                <span class="star" data-value="3">★</span>
                                                <span class="star" data-value="4">★</span>
                                                <span class="star" data-value="5">★</span>
                                            </div>
                                            <div class="rating-actions">
                                                <div id="ratingMessage" class="rating-message"></div>
                                                <button id="submitRating" class="rate-btn" disabled>Submit Rating</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div id="reviewFormContainer" class="review-form" style="display: none;">
                                    <h4>Write a Review</h4>
                                    <div class="star-container">
                                        <span class="star review-star" data-value="1">★</span>
                                        <span class="star review-star" data-value="2">★</span>
                                        <span class="star review-star" data-value="3">★</span>
                                        <span class="star review-star" data-value="4">★</span>
                                        <span class="star review-star" data-value="5">★</span>
                                    </div>
                                    <div class="form-group">
                                        <label for="reviewText"><strong>Your Comment:</strong></label>
                                        <textarea id="reviewText" class="review-textarea" placeholder="Share your experience with this college..." rows="4"></textarea>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                                        <div id="reviewMessage" class="review-message"></div>
                                        <button id="submitReview" class="rate-btn">Submit Review</button>
                                    </div>
                                </div>
                                
                                <div id="reviewsList" class="review-list">
                                    <div class="no-reviews">No reviews yet. Be the first to review!</div>
                                </div>
                                
                                <div id="reviewPagination" class="pagination"></div>
                            </div>

                            <div class="college-section">
                                <h2>Available Courses</h2>
                                <div id="coursesList" class="course-list">
                                    <p>Loading courses...</p>
                                </div>
                            </div>

                            <div class="college-section">
                                <h2>Upcoming Events</h2>
                                <div id="eventsList" class="events-list">
                                    <p>Loading events...</p>
                                </div>
                            </div>

                            <div class="college-section">
                                <h2>Campus Amenities</h2>
                                <p>${college.amenities || 'Library, Sports Complex, Cafeteria, Computer Labs, Wi-Fi Campus'}</p>
                            </div>
                            
                            <div class="college-section">
                                <h2>Campus Location & Facilities</h2>
                                <div class="map-facilities-grid">
                                    <div id="mapContainer">
                                        <!-- Map will be loaded here -->
                                    </div>
                                    <div class="facilities-container">
                                        <div class="facilities-header">
                                            <h3 class="facilities-title">Campus Facilities</h3>
                                            <div class="facilities-filter">
                                                <button class="filter-btn active" data-filter="all">All</button>
                                                <button class="filter-btn" data-filter="library">Library</button>
                                                <button class="filter-btn" data-filter="sports">Sports</button>
                                                <button class="filter-btn" data-filter="food">Food</button>
                                                <button class="filter-btn" data-filter="residence">Residence</button>
                                            </div>
                                        </div>
                                        <div class="facilities-list" id="facilitiesList">
                                            <p class="no-facilities">Loading facilities...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="college-section">
                                <h2>Campus Gallery</h2>
                                <div id="photoGalleryContainer">
                                    <!-- Photos will be loaded here -->
                                </div>
                            </div>

                            <a href="/" class="back-btn">Back to Search</a>
                        </div>
                     `;

                    // Add rating to the header
                    if (college.avg_rating) {
                        const metaSection = document.querySelector('.college-meta');
                        const rankSpan = document.querySelector('.college-meta span:nth-child(2)');
                        
                        if (metaSection && rankSpan) {
                            const ratingSpan = document.createElement('span');
                            ratingSpan.innerHTML = `<i class="fas fa-star" style="color: #f6ad55;"></i> Rating: ${college.avg_rating.toFixed(1)}/5`;
                            metaSection.insertBefore(ratingSpan, rankSpan.nextSibling);
                        }
                    }
                    
                    // Load the rating system
                    loadRatingSystem(collegeId);

                    // Fetch courses for this college
                    fetch(`/college/${collegeId}/courses`)
                        .then(response => response.json())
                        .then(courses => {
                            const coursesList = document.getElementById('coursesList');
                            if (courses.length === 0) {
                                coursesList.innerHTML = '<p>No courses information available.</p>';
                                return;
                            }
                            coursesList.innerHTML = '';
                            courses.forEach(course => {
                                const courseCard = document.createElement('div');
                                courseCard.className = 'course-card';
                                courseCard.innerHTML = `
                                    <div class="course-name">${course.name}</div>
                                    <div>${course.degree_type || ''} ${course.duration || ''}</div>
                                    <div class="course-details">
                                        <p>
                                            <span class="label">Annual Fee:</span>
                                            <span class="value">₹${course.annual_fee ? course.annual_fee.toLocaleString('en-IN') : 'N/A'}</span>
                                        </p>
                                        <p>
                                            <span class="label">Seats:</span>
                                            <span class="value">${course.seats || 'N/A'}</span>
                                        </p>
                                    </div>
                                `;
                                coursesList.appendChild(courseCard);
                            });
                        })
                        .catch(error => {
                            console.error('Error fetching courses:', error);
                            document.getElementById('coursesList').innerHTML =
                                '<p>Could not load course information.</p>';
                        });

                    // Fetch events for this college
                    fetch(`/college/${collegeId}/events`)
                        .then(response => response.json())
                        .then(events => {
                            const eventsList = document.getElementById('eventsList');
                            if (events.length === 0) {
                                eventsList.innerHTML = '<p>No upcoming events at this time.</p>';
                                return;
                            }
                            eventsList.innerHTML = '';
                            events.forEach(event => {
                                const eventDate = new Date(event.event_date);
                                const formattedDate = eventDate.toLocaleDateString('en-US', {
                                    weekday: 'short',
                                    month: 'short',
                                    day: 'numeric',
                                    year: 'numeric'
                                });
                                const formattedTime = eventDate.toLocaleTimeString('en-US', {
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                const eventCard = document.createElement('div');
                                eventCard.className = 'event-card';
                                eventCard.innerHTML = `
                                    <div class="event-header">
                                        <div class="event-title">${event.title}</div>
                                        <div class="event-date">${formattedDate}, ${formattedTime}</div>
                                    </div>
                                    <div class="event-location">
                                        <i class="fas fa-map-marker-alt"></i> ${event.location || 'College Campus'}
                                    </div>
                                    <div class="event-description">${event.description || ''}</div>
                                    ${event.registration_url ? `<a href="${event.registration_url}" class="event-register" target="_blank">Register</a>` : ''}
                                `;
                                eventsList.appendChild(eventCard);
                            });
                        })
                        .catch(error => {
                            console.error('Error fetching events:', error);
                            document.getElementById('eventsList').innerHTML =
                                '<p>Could not load event information.</p>';
                        });

                    // Load photo gallery and map
                    fetch(`/college/${collegeId}`)
                        .then(response => response.json())
                        .then(college => {
                            // Add photo gallery
                            const photoContainer = document.getElementById('photoGalleryContainer');
                            let hasPhotos = false;
                            let photosHtml = '<div class="photo-gallery" style="display: flex; overflow-x: auto; gap: 15px; padding: 10px 0;">';

                            // Helper function to check if image exists
                            function addImageWithFallback(url, index) {
                                if (!url) return '';

                                // Create a data URI for a placeholder image
                                const placeholderImage = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjAwIDgwMCIgd2lkdGg9IjEyMDAiIGhlaWdodD0iODAwIj48cmVjdCBmaWxsPSIjZWVlZWVlIiB3aWR0aD0iMTIwMCIgaGVpZ2h0PSI4MDAiLz48dGV4dCBmaWxsPSIjOTk5OTk5IiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIzNiIgeD0iNTAwIiB5PSI0MjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiPkltYWdlIGxvYWRpbmcgZmFpbGVkPC90ZXh0Pjwvc3ZnPg==';
                                return `<img src="${url}" alt="Campus view ${index}" style="height: 200px; border-radius: 8px; cursor: pointer;" onerror="this.onerror=null; this.src='${placeholderImage}'; this.style.opacity='0.7';" onclick="window.open('${url}', '_blank')">`;
                            }

                            // Add photos to the gallery
                            if (college.photo_link1) {
                                photosHtml += addImageWithFallback(college.photo_link1, 1);
                                hasPhotos = true;
                            }
                            if (college.photo_link2) {
                                photosHtml += addImageWithFallback(college.photo_link2, 2);
                                hasPhotos = true;
                            }
                            if (college.photo_link3) {
                                photosHtml += addImageWithFallback(college.photo_link3, 3);
                                hasPhotos = true;
                            }
                            if (college.photo_link4) {
                                photosHtml += addImageWithFallback(college.photo_link4, 4);
                                hasPhotos = true;
                            }

                            // Close the photo gallery div
                            photosHtml += '</div>';

                            // Set the HTML content based on whether photos were found
                            if (hasPhotos) {
                                photoContainer.innerHTML = photosHtml;
                            } else {
                                photoContainer.innerHTML = '<div style="padding: 30px; text-align: center; background: #f8fafc; border-radius: 8px; color: #718096;">No campus photos available</div>';
                            }

                            // Add map
                            const mapContainer = document.getElementById('mapContainer');

                            // Function to create a fallback map based on college name and location
                            function createFallbackMap(name, location) {
                                return `
                                    <iframe 
                                        width="100%" 
                                        height="400" 
                                        frameborder="0" 
                                        style="border:0; border-radius: 8px;" 
                                        src="https://maps.google.com/maps?q=${encodeURIComponent(name + ', ' + location)}&output=embed" 
                                        allowfullscreen>
                                    </iframe>
                                `;
                            }

                            // If there's a map link, try to use it; otherwise create a fallback map
                            try {
                                // Store both map views for toggling
                                let normalMapHTML = '';

                                // Set up the normal map view
                                if (college.map_link) {
                                    // If it contains iframe HTML code, insert it directly
                                    if (college.map_link.trim().includes('<iframe')) {
                                        normalMapHTML = college.map_link;
                                    }
                                    // Fallback for old-style links
                                    else {
                                        normalMapHTML = createFallbackMap(college.name, college.location);
                                    }
                                } else {
                                    // Case 4: No map link - create a fallback map based on college name and location
                                    normalMapHTML = createFallbackMap(college.name, college.location);
                                }

                                // Apply the normal map initially
                                mapContainer.innerHTML = normalMapHTML;

                                // Set up immersive view if available
                                if (college.satellite_link) {
                                    // Create a toggle button
                                    const toggleButton = document.createElement('button');
                                    toggleButton.className = 'toggle-view-btn';
                                    toggleButton.style = 'display: inline-block; margin-top: 10px; padding: 8px 16px; background: #3a6ea5; color: white; text-decoration: none; border-radius: 4px; border: none; cursor: pointer;';
                                    toggleButton.textContent = 'Switch to Immersive View';

                                    // State tracking
                                    let isImmersiveMode = false;

                                    // Toggle between views
                                    toggleButton.addEventListener('click', function() {
                                        if (isImmersiveMode) {
                                            // Switch to normal view
                                            mapContainer.innerHTML = normalMapHTML;
                                            toggleButton.textContent = 'Switch to Immersive View';
                                            isImmersiveMode = false;
                                        } else {
                                            // Switch to immersive view
                                            mapContainer.innerHTML = college.satellite_link;
                                            toggleButton.textContent = 'Switch to Normal View';
                                            isImmersiveMode = true;
                                        }
                                        
                                        // Re-append the button after changing the content
                                        mapContainer.appendChild(toggleButton);
                                    });
                                    
                                    mapContainer.appendChild(toggleButton);
                                }
                            } catch (e) {
                                console.error('Map embedding error:', e);
                                // Even if there's an error, try to create a fallback map
                                mapContainer.innerHTML = createFallbackMap(college.name, college.location);
                            }

                            // Now fetch facilities INSIDE this promise chain where collegeId is defined
                            console.log("Fetching facilities for college ID:", collegeId);
                            return fetch(`/college/${collegeId}/facilities`);
                        })
                        .then(response => {
                            console.log("Facilities response status:", response.status);
                            return response.json();
                        })
                        .then(facilities => {
                            console.log("Received facilities data:", facilities);
                            const facilitiesList = document.getElementById('facilitiesList');

                            if (facilities.length === 0) {
                                facilitiesList.innerHTML = '<p class="no-facilities">No facilities information available.</p>';
                                return;
                            }

                            facilitiesList.innerHTML = '';
                            facilities.forEach(facility => {
                                const facilityItem = document.createElement('div');
                                facilityItem.className = 'facility-item';
                                facilityItem.dataset.type = facility.type;

                                // Choose icon based on facility type
                                let icon = 'question';
                                switch (facility.type) {
                                    case 'library': icon = 'book'; break;
                                    case 'sports': icon = 'running'; break;
                                    case 'food': icon = 'utensils'; break;
                                    case 'residence': icon = 'home'; break;
                                    case 'lab': icon = 'flask'; break;
                                    case 'medical': icon = 'first-aid'; break;
                                    case 'transport': icon = 'bus'; break;
                                    default: icon = 'building';
                                }
                                
                                facilityItem.innerHTML = `
                                    <div class="facility-icon">
                                        <i class="fas fa-${icon}"></i>
                                    </div>
                                    <div class="facility-info">
                                        <div class="facility-name">${facility.name}</div>
                                        <div class="facility-location">${facility.location || 'On campus'}</div>
                                    </div>
                                    ${facility.distance ? `<div class="facility-distance">${facility.distance}</div>` : ''}
                                `;
                                facilitiesList.appendChild(facilityItem);
                            });

                            // Add filter functionality
                            const filterButtons = document.querySelectorAll('.filter-btn');
                            filterButtons.forEach(button => {
                                button.addEventListener('click', () => {
                                    // Update active state
                                    filterButtons.forEach(btn => btn.classList.remove('active'));
                                    button.classList.add('active');
                                    const filter = button.dataset.filter;
                                    const items = document.querySelectorAll('.facility-item');
                                    items.forEach(item => {
                                        if (filter === 'all' || item.dataset.type === filter) {
                                            item.style.display = 'flex';
                                        } else {
                                            item.style.display = 'none';
                                        }
                                    });
                                });
                            });
                        })
                        .catch(error => {
                            console.error('Error fetching college data or facilities:', error);
                        });

            // Check if user is logged in
            fetch('/check-auth')
                .then(response => response.json())
                .then(data => {
                    if (data.authenticated) {
                        document.getElementById('loginLink').style.display = 'none';
                        document.getElementById('registerLink').style.display = 'none';
                        document.getElementById('logoutLink').style.display = 'inline';
                        document.getElementById('userWelcome').style.display = 'inline';
                        document.getElementById('username').textContent = data.username;
                    }
                })
                .catch(error => console.error('Error checking auth:', error));

            // Handle logout
            document.getElementById('logoutLink').addEventListener('click', function (e) {
                e.preventDefault();
                fetch('/logout')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        }
                    })
                    .catch(error => console.error('Error during logout:', error));
            });

            // Function to load and handle the rating system
            function loadRatingSystem(collegeId) {
                // Check if user is logged in
                fetch('/check-auth')
                    .then(response => response.json())
                    .then(data => {
                        if (data.authenticated) {
                            // Store user ID globally
                            currentUserId = data.userId;
                            
                            // User is logged in, show rating and review form
                            document.getElementById('ratingControls').style.display = 'block';
                            document.getElementById('reviewFormContainer').style.display = 'block';
                            document.getElementById('loginToRate').style.display = 'none';
                            
                            // Setup rating stars
                            setupRatingStars(collegeId);
                            
                            // Setup review stars
                            setupReviewStars(collegeId);
                            
                            // Setup review form submission
                            document.getElementById('submitReview').addEventListener('click', function() {
                                // Get rating from review stars
                                const activeStars = document.querySelectorAll('.review-star.active');
                                const rating = activeStars.length;
                                
                                if (rating === 0) {
                                    alert('Please select a rating (1-5 stars)');
                                    return;
                                }
                                
                                const reviewText = document.getElementById('reviewText').value;
                                submitReview(collegeId, rating, reviewText);
                            });
                        } else {
                            // User is not logged in, show login message
                            document.getElementById('ratingControls').style.display = 'none';
                            document.getElementById('reviewFormContainer').style.display = 'none';
                            document.getElementById('loginToRate').style.display = 'block';
                        }
                        
                        // Load current rating data and reviews
                        loadRatingData(collegeId);
                        loadCollegeReviews(collegeId);
                    })
                    .catch(error => {
                        console.error('Error checking authentication:', error);
                    });
            }
            
            function loadRatingData(collegeId) {
                fetch(`/college/${collegeId}/rating`)
                    .then(response => response.json())
                    .then(data => {
                        // Update average rating display
                        document.getElementById('avgRatingValue').textContent = data.averageRating ? data.averageRating.toFixed(1) : '0.0';
                        document.getElementById('ratingCount').textContent = data.ratingCount || '0';
                        
                        // If user has already rated, show their rating
                        if (data.userRating) {
                            setActiveStars(data.userRating);
                            document.getElementById('ratingMessage').textContent = 'You have already rated this college';
                            document.getElementById('ratingMessage').className = 'rating-message success';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading rating data:', error);
                    });
            }
            
            function setupRatingStars(collegeId, userId) {
                const stars = document.querySelectorAll('.star');
                const submitBtn = document.getElementById('submitRating');
                let selectedRating = 0;
                
                // Handle star hover
                stars.forEach(star => {
                    star.addEventListener('mouseover', function() {
                        const value = parseInt(this.dataset.value);
                        
                        // Highlight this star and all stars before it
                        stars.forEach(s => {
                            const starValue = parseInt(s.dataset.value);
                            if (starValue <= value) {
                                s.classList.add('hover');
                            } else {
                                s.classList.remove('hover');
                            }
                        });
                    });
                    
                    star.addEventListener('mouseout', function() {
                        // Remove hover effect from all stars
                        stars.forEach(s => s.classList.remove('hover'));
                    });
                    
                    star.addEventListener('click', function() {
                        const value = parseInt(this.dataset.value);
                        selectedRating = value;
                        
                        // Update active stars
                        setActiveStars(value);
                        
                        // Enable submit button
                        submitBtn.disabled = false;
                    });
                });
                
                // Handle submit button
                submitBtn.addEventListener('click', function() {
                    if (selectedRating > 0) {
                        submitRating(collegeId, userId, selectedRating);
                    }
                });
            }
            
            function setActiveStars(rating) {
                const stars = document.querySelectorAll('.star');
                stars.forEach(star => {
                    const value = parseInt(star.dataset.value);
                    if (value <= rating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
            }
            
            function submitRating(collegeId, userId, rating) {
                fetch(`/college/${collegeId}/rating`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rating: rating,
                        userId: userId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        document.getElementById('ratingMessage').textContent = 'Rating submitted successfully!';
                        document.getElementById('ratingMessage').className = 'rating-message success';
                        
                        // Refresh rating data
                        loadRatingData(collegeId);
                    } else {
                        // Show error message
                        document.getElementById('ratingMessage').textContent = data.message || 'Error submitting rating';
                        document.getElementById('ratingMessage').className = 'rating-message error';
                    }
                })
                .catch(error => {
                    console.error('Error submitting rating:', error);
                    document.getElementById('ratingMessage').textContent = 'Error submitting rating';
                    document.getElementById('ratingMessage').className = 'rating-message error';
                });
            }

            // Global variable to store current user ID
            let currentUserId = null;
            
            // Setup review stars
            function setupReviewStars(collegeId) {
                const stars = document.querySelectorAll('.review-star');
                let selectedRating = 0;
                
                // Handle star hover
                stars.forEach(star => {
                    star.addEventListener('mouseover', function() {
                        const value = parseInt(this.dataset.value);
                        
                        // Highlight this star and all stars before it
                        stars.forEach(s => {
                            const starValue = parseInt(s.dataset.value);
                            if (starValue <= value) {
                                s.classList.add('hover');
                            } else {
                                s.classList.remove('hover');
                            }
                        });
                    });
                    
                    star.addEventListener('mouseout', function() {
                        // Remove hover effect from all stars
                        stars.forEach(s => s.classList.remove('hover'));
                    });
                    
                    star.addEventListener('click', function() {
                        const value = parseInt(this.dataset.value);
                        selectedRating = value;
                        
                        // Update active stars
                        stars.forEach(s => {
                            const starValue = parseInt(s.dataset.value);
                            if (starValue <= value) {
                                s.classList.add('active');
                            } else {
                                s.classList.remove('active');
                            }
                        });
                    });
                });
            }

            // Load and display college reviews
            function loadCollegeReviews(collegeId) {
                fetch(`/college/${collegeId}/reviews`)
                    .then(response => response.json())
                    .then(data => {
                        // Update reviews count
                        const totalReviewsElement = document.getElementById('totalReviews');
                        if (totalReviewsElement) {
                            totalReviewsElement.textContent = data.totalReviews || '0';
                        }
                        
                        // Display reviews
                        displayReviews(data.reviews);
                        
                        // If user has already reviewed, pre-fill the form
                        if (data.userReview) {
                            prefillReviewForm(data.userReview);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading reviews:', error);
                    });
            }

            // Display reviews in the list
            function displayReviews(reviews) {
                const reviewsList = document.getElementById('reviewsList');
                
                if (reviews.length === 0) {
                    reviewsList.innerHTML = '<div class="no-reviews">No reviews yet. Be the first to review!</div>';
                    return;
                }
                
                reviewsList.innerHTML = '';
                
                // Sort reviews: user's review first, then by date (newest first)
                const sortedReviews = [...reviews].sort((a, b) => {
                    // If user's review, put it first
                    if (a.user_id === currentUserId) return -1;
                    if (b.user_id === currentUserId) return 1;
                    
                    // Otherwise sort by date (newest first)
                    return new Date(b.created_at) - new Date(a.created_at);
                });
                
                // Show reviews
                sortedReviews.forEach(review => {
                    const date = new Date(review.created_at);
                    const formattedDate = `${date.toLocaleDateString()} at ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                    
                    const isOwnReview = currentUserId && review.user_id === currentUserId;
                    
                    const reviewItem = document.createElement('div');
                    reviewItem.className = 'review-item';
                    reviewItem.innerHTML = `
                        <div class="review-header">
                            <div class="review-author">${isOwnReview ? 'You' : review.username}</div>
                            <div class="review-date">${formattedDate}</div>
                        </div>
                        <div class="review-rating">
                            ${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}
                        </div>
                        <div class="review-text">${review.review_text || 'No comments provided.'}</div>
                        ${isOwnReview ? `
                        <div class="review-actions">
                            <button class="review-btn" onclick="editReview(${review.id})">Edit</button>
                            <button class="review-btn delete" onclick="deleteReview(${review.id})">Delete</button>
                        </div>
                        ` : ''}
                     `;
                    
                    reviewsList.appendChild(reviewItem);
                });
            }

            // Pre-fill review form with user's existing review
            function prefillReviewForm(userReview) {
                // Set stars 
                const stars = document.querySelectorAll('.review-star');
                stars.forEach(star => {
                    const value = parseInt(star.dataset.value);
                    if (value <= userReview.rating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
                
                // Set text
                document.getElementById('reviewText').value = userReview.reviewText || '';
                
                // Update button text
                document.getElementById('submitReview').textContent = 'Update Review';
            }

            // Submit or update review
            function submitReview(collegeId, rating, reviewText) {
                fetch(`/college/${collegeId}/reviews`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rating,
                        reviewText
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        const messageDiv = document.getElementById('reviewMessage');
                        messageDiv.textContent = data.message;
                        messageDiv.className = 'review-message success';
                        
                        // Refresh reviews
                        loadCollegeReviews(collegeId);
                        
                        // Also refresh rating data
                        loadRatingData(collegeId);
                    } else {
                        // Show error message
                        const messageDiv = document.getElementById('reviewMessage');
                        messageDiv.textContent = data.error || 'Error submitting review';
                        messageDiv.className = 'review-message error';
                    }
                })
                .catch(error => {
                    console.error('Error submitting review:', error);
                    const messageDiv = document.getElementById('reviewMessage');
                    messageDiv.textContent = 'Error submitting review';
                    messageDiv.className = 'review-message error';
                });
            }

            // Delete a review
            function deleteReview(reviewId) {
                if (!confirm('Are you sure you want to delete your review?')) {
                    return;
                }
                
                const urlParams = new URLSearchParams(window.location.search);
                const collegeId = urlParams.get('id');
                
                fetch(`/college/${collegeId}/reviews/${reviewId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Refresh reviews
                        loadCollegeReviews(collegeId);
                        
                        // Reset form
                        document.getElementById('reviewText').value = '';
                        document.querySelectorAll('.review-star').forEach(star => {
                            star.classList.remove('active');
                        });
                        
                        // Update button text
                        document.getElementById('submitReview').textContent = 'Submit Review';
                        
                        // Also refresh rating data
                        loadRatingData(collegeId);
                    } else {
                        alert(data.error || 'Error deleting review');
                    }
                })
                .catch(error => {
                    console.error('Error deleting review:', error);
                    alert('Error deleting review');
                });
            }

            // Edit a review (just prefill the form, submission handled by submitReview)
            function editReview(reviewId) {
                // Scroll to the review form
                document.getElementById('reviewFormContainer').scrollIntoView({ behavior: 'smooth' });
            }

            setTimeout(() => {
                const applyButton = document.getElementById('applyNowBtn');
                if (applyButton) {
                    applyButton.addEventListener('click', function () {
                        // Get college ID and name from URL parameters
                        const urlParams = new URLSearchParams(window.location.search);
                        const collegeId = urlParams.get('id');
                        const collegeName = document.querySelector('.college-header h1').textContent;

                        // Check if user is logged in
                        fetch('/check-auth')
                            .then(response => response.json())
                            .then(data => {
                                if (data.authenticated) {
                                    // User is logged in, show application form
                                    document.getElementById('applicationCollegeId').value = collegeId;
                                    document.getElementById('collegeNameInForm').textContent = collegeName;
                                    
                                    // Load available courses for this college
                                    loadCoursesForApplication(collegeId);
                                    
                                    // Show the application modal
                                    document.getElementById('applicationFormModal').style.display = 'block';
                                } else {
                                    // User is not logged in, show login prompt
                                    document.getElementById('loginPromptModal').style.display = 'block';
                                }
                            })
                            .catch(error => {
                                console.error('Error checking authentication:', error);
                                alert('Something went wrong. Please try again.');
                            });
                    });
                }
            }, 1000);
            
            // Function to load courses for the application form dropdown
            function loadCoursesForApplication(collegeId) {
                fetch(`/college/${collegeId}/courses`)
                    .then(response => response.json())
                    .then(courses => {
                        const courseSelect = document.getElementById('preferredCourse');
                        // Clear existing options except the first one
                        courseSelect.innerHTML = '<option value="">Select a course</option>';
                        
                        // Add courses to the dropdown
                        courses.forEach(course => {
                            const option = document.createElement('option');
                            option.value = course.id;
                            option.textContent = `${course.name} (${course.degree_type})`;
                            courseSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading courses:', error);
                        document.getElementById('preferredCourse').innerHTML = '<option value="">Courses not available</option>';
                    });
            }
            
            // Handle application form submission
            document.getElementById('applicationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const collegeId = document.getElementById('applicationCollegeId').value;
                const applicationData = {
                    collegeId: collegeId,
                    fullName: document.getElementById('fullName').value,
                    phoneNumber: document.getElementById('phoneNumber').value,
                    preferredCourse: document.getElementById('preferredCourse').value,
                    educationLevel: document.getElementById('educationLevel').value,
                    message: document.getElementById('message').value,
                    preferredTime: document.getElementById('preferredTime').value
                };
                
                // Display a loading message
                const messageEl = document.getElementById('applicationMessage');
                messageEl.style.display = 'block';
                messageEl.innerHTML = '<div style="color: #718096;">Submitting your application...</div>';
                
                fetch(`/applications`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(applicationData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        messageEl.innerHTML = '<div style="color: #38a169;">Application submitted successfully! The admissions team will contact you soon.</div>';
                        
                        // Clear the form
                        document.getElementById('applicationForm').reset();
                        
                        // Close the modal after a delay
                        setTimeout(() => {
                            document.getElementById('applicationFormModal').style.display = 'none';
                            messageEl.style.display = 'none';
                        }, 3000);
                    } else {
                        // Show error message
                        messageEl.innerHTML = `<div style="color: #e53e3e;">${data.error || 'Failed to submit application. Please try again.'}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Error submitting application:', error);
                    messageEl.innerHTML = '<div style="color: #e53e3e;">An error occurred. Please try again.</div>';
                });
            });
        });
    });
    </script>
</body>
</html>